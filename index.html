<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É°„Ç¨„É≠„Éù„É™„Çπ - 3DÈÉΩÂ∏ÇÈñãÁô∫„Ç∑„Éü„É•„É¨„Éº„Çø„Éº</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #2a5298);
            color: white;
            min-height: 100vh;
            overflow: hidden;
            touch-action: none;
        }
        .game-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: 100vh;
            gap: 8px;
            padding: 8px;
        }
        .panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .city-view {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        #city3d {
            width: 100%;
            height: 100%;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            margin: 5px 0;
            color: #4FC3F7;
        }
        .building-category {
            margin: 20px 0;
        }
        .category-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .building-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .building-card:active {
            transform: scale(0.95);
        }
        .building-card.available:hover {
            border-color: #4FC3F7;
            background: rgba(79, 195, 247, 0.15);
            transform: translateY(-2px);
        }
        .building-card.unavailable {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .building-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .building-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .building-desc {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.3;
            margin-bottom: 8px;
        }
        .building-cost {
            font-size: 12px;
            color: #FFD700;
            font-weight: bold;
        }
        .progress-container {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 4px;
            margin: 10px 0;
        }
        .progress-bar {
            height: 8px;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #F44336);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            padding: 15px 20px;
            border-radius: 15px;
            z-index: 1000;
            animation: slideInRight 0.5s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .construction-effect {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }
        .pulse {
            animation: pulse 1.5s ease-out;
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        .control-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 0;
            transition: all 0.3s ease;
            width: 100%;
        }
        .control-button:active {
            transform: scale(0.95);
        }
        .control-button.secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
        .day-night-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            z-index: 100;
        }
        .mini-map {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: rgba(0,0,0,0.7);
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            z-index: 100;
        }
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700, #FF9800);
            color: black;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            z-index: 1000;
            animation: achievementPop 2s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        .building-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Â∑¶„Éë„Éç„É´: ÈÉΩÂ∏ÇÁµ±Ë®à -->
        <div class="panel">
            <h2 style="text-align: center; margin-bottom: 20px; color: #FFD700;">üèôÔ∏è „É°„Ç¨„É≠„Éù„É™„Çπ</h2>
            
            <div class="stat-card">
                <div>üí∞ Ë≥áÈáë</div>
                <div class="stat-value" id="money">10,000,000</div>
                <div>ÂèéÂÖ•/„Çø„Éº„É≥: <span id="income">+50,000</span></div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div>üë• ‰∫∫Âè£</div>
                    <div class="stat-value" id="population">5,000</div>
                </div>
                <div class="stat-card">
                    <div>üåø Áí∞Â¢É</div>
                    <div class="stat-value" id="environment">85%</div>
                </div>
                <div class="stat-card">
                    <div>üíπ ÁµåÊ∏à</div>
                    <div class="stat-value" id="economy">65%</div>
                </div>
                <div class="stat-card">
                    <div>üòä Âπ∏Á¶èÂ∫¶</div>
                    <div class="stat-value" id="happiness">78%</div>
                </div>
            </div>

            <div class="progress-container">
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                    <span>SDGsÈÅîÊàêÂ∫¶</span>
                    <span id="sdgsProgress">42%</span>
                </div>
                <div class="progress-bar" style="width: 42%"></div>
            </div>

            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>„Çø„Éº„É≥: <strong id="turn">1</strong></span>
                    <span>ÈÉΩÂ∏Ç„É¨„Éô„É´: <strong id="cityLevel">3</strong></span>
                </div>
                <button class="control-button" onclick="nextTurn()">
                    ‚è≠Ô∏è Ê¨°„ÅÆ„Çø„Éº„É≥„Å∏
                </button>
            </div>

            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                <h4 style="color: #FFD700; margin-bottom: 10px;">üèÜ ÂÆüÁ∏æ</h4>
                <div id="achievements" style="font-size: 12px; max-height: 120px; overflow-y: auto;">
                    <div>üåü ÊúÄÂàù„ÅÆ‰∏ÄÊ≠©</div>
                </div>
            </div>
        </div>

        <!-- ‰∏≠Â§Æ: 3DÈÉΩÂ∏Ç„Éì„É•„Éº -->
        <div class="city-view">
            <div id="city3d"></div>
            <button class="day-night-toggle" onclick="toggleDayNight()">üåô Â§ú„É¢„Éº„Éâ</button>
            <div class="mini-map" id="miniMap"></div>
            <div id="constructionEffects"></div>
        </div>

        <!-- Âè≥„Éë„Éç„É´: Âª∫Ë®≠„É°„Éã„É•„Éº -->
        <div class="panel">
            <h3 style="color: #FFD700; margin-bottom: 20px;">üèóÔ∏è Âª∫Ë®≠„É°„Éã„É•„Éº</h3>

            <div class="building-category">
                <div class="category-title">üè† ‰ΩèÂÆÖÂú∞Âå∫</div>
                <div class="building-card available" onclick="buildBuilding('residential')" data-cost="100000">
                    <div class="building-icon">üèòÔ∏è</div>
                    <div class="building-name">‰ΩèÂÆÖÂú∞Âå∫</div>
                    <div class="building-desc">‰∫∫Âè£+200, ÂèéÂÖ•+300/„Çø„Éº„É≥</div>
                    <div class="building-cost">üí∞ 100,000</div>
                </div>
                <div class="building-card available" onclick="buildBuilding('apartment')" data-cost="300000">
                    <div class="building-icon">üè¢</div>
                    <div class="building-name">È´òÂ±§„Ç¢„Éë„Éº„Éà</div>
                    <div class="building-desc">‰∫∫Âè£+500, ÂèéÂÖ•+800/„Çø„Éº„É≥</div>
                    <div class="building-cost">üí∞ 300,000</div>
                </div>
            </div>

            <div class="building-category">
                <div class="category-title">üè™ ÂïÜÊ•≠Âú∞Âå∫</div>
                <div class="building-card available" onclick="buildBuilding('commercial')" data-cost="150000">
                    <div class="building-icon">üõçÔ∏è</div>
                    <div class="building-name">ÂïÜÊ•≠Âú∞Âå∫</div>
                    <div class="building-desc">ÂèéÂÖ•+600/„Çø„Éº„É≥, ÁµåÊ∏à+8%</div>
                    <div class="building-cost">üí∞ 150,000</div>
                </div>
                <div class="building-card available" onclick="buildBuilding('business')" data-cost="500000">
                    <div class="building-icon">üèõÔ∏è</div>
                    <div class="building-name">„Éì„Ç∏„Éç„Çπ„Éë„Éº„ÇØ</div>
                    <div class="building-desc">ÂèéÂÖ•+1500/„Çø„Éº„É≥, ÁµåÊ∏à+15%</div>
                    <div class="building-cost">üí∞ 500,000</div>
                </div>
            </div>

            <div class="building-category">
                <div class="category-title">üè≠ Â∑•Ê•≠Âú∞Âå∫</div>
                <div class="building-card available" onclick="buildBuilding('factory')" data-cost="200000">
                    <div class="building-icon">üè≠</div>
                    <div class="building-name">Â∑•Â†¥Âú∞Âå∫</div>
                    <div class="building-desc">ÂèéÂÖ•+1000/„Çø„Éº„É≥, Áí∞Â¢É-10%</div>
                    <div class="building-cost">üí∞ 200,000</div>
                </div>
                <div class="building-card available" onclick="buildBuilding('tech_park')" data-cost="600000">
                    <div class="building-icon">üî¨</div>
                    <div class="building-name">„Éè„Ç§„ÉÜ„ÇØ„Éë„Éº„ÇØ</div>
                    <div class="building-desc">ÂèéÂÖ•+2000/„Çø„Éº„É≥, ÁµåÊ∏à+20%</div>
                    <div class="building-cost">üí∞ 600,000</div>
                </div>
            </div>

            <div class="building-category">
                <div class="category-title">üåø Áí∞Â¢ÉÊñΩË®≠</div>
                <div class="building-card available" onclick="buildBuilding('park')" data-cost="80000">
                    <div class="building-icon">üå≥</div>
                    <div class="building-name">‰∏≠Â§ÆÂÖ¨Âúí</div>
                    <div class="building-desc">Áí∞Â¢É+15%, Âπ∏Á¶èÂ∫¶+10%</div>
                    <div class="building-cost">üí∞ 80,000</div>
                </div>
                <div class="building-card available" onclick="buildBuilding('solar_farm')" data-cost="250000">
                    <div class="building-icon">‚òÄÔ∏è</div>
                    <div class="building-name">Â§™ÈôΩÂÖâÁô∫ÈõªÊâÄ</div>
                    <div class="building-desc">Áí∞Â¢É+25%, ÂèéÂÖ•+400/„Çø„Éº„É≥</div>
                    <div class="building-cost">üí∞ 250,000</div>
                </div>
            </div>

            <div class="building-category">
                <div class="category-title">üéØ ÁâπÊÆäÊñΩË®≠</div>
                <div class="building-card available" onclick="buildBuilding('stadium')" data-cost="800000">
                    <div class="building-icon">üèüÔ∏è</div>
                    <div class="building-name">„Çπ„Çø„Ç∏„Ç¢„É†</div>
                    <div class="building-desc">Âπ∏Á¶èÂ∫¶+20%, ÂèéÂÖ•+1000/„Çø„Éº„É≥</div>
                    <div class="building-cost">üí∞ 800,000</div>
                </div>
                <div class="building-card available" onclick="buildBuilding('landmark')" data-cost="1200000">
                    <div class="building-icon">üóº</div>
                    <div class="building-name">„É©„É≥„Éâ„Éû„Éº„ÇØ„Çø„ÉØ„Éº</div>
                    <div class="building-desc">ÈÉΩÂ∏Ç„É¨„Éô„É´+2, Ë¶≥ÂÖâÂèéÂÖ•+2000/„Çø„Éº„É≥</div>
                    <div class="building-cost">üí∞ 1,200,000</div>
                </div>
            </div>

            <button class="control-button secondary" onclick="showCityReport()">
                üìä ÈÉΩÂ∏Ç„É¨„Éù„Éº„Éà„ÇíË¶ã„Çã
            </button>
        </div>
    </div>

    <script>
        // „Ç≤„Éº„É†Áä∂ÊÖã
        const gameState = {
            money: 10000000,
            income: 50000,
            population: 5000,
            environment: 85,
            economy: 65,
            happiness: 78,
            turn: 1,
            cityLevel: 3,
            isDay: true,
            buildings: [],
            achievements: ['üåü ÊúÄÂàù„ÅÆ‰∏ÄÊ≠©']
        };

        // Three.jsÂ§âÊï∞
        let scene, camera, renderer, controls;
        let sunLight, ambientLight;
        const buildingMeshes = [];
        const gridSize = 50;
        const grid = [];

        // Âª∫Áâ©„ÅÆË®≠ÂÆö
        const buildingConfigs = {
            residential: { 
                color: 0xff6b6b, 
                height: 2, 
                name: "‰ΩèÂÆÖÂú∞Âå∫",
                effects: { population: 200, income: 300 }
            },
            apartment: { 
                color: 0x74b9ff, 
                height: 4, 
                name: "È´òÂ±§„Ç¢„Éë„Éº„Éà",
                effects: { population: 500, income: 800 }
            },
            commercial: { 
                color: 0xfdcb6e, 
                height: 2.5, 
                name: "ÂïÜÊ•≠Âú∞Âå∫",
                effects: { income: 600, economy: 8 }
            },
            business: { 
                color: 0x636e72, 
                height: 5, 
                name: "„Éì„Ç∏„Éç„Çπ„Éë„Éº„ÇØ",
                effects: { income: 1500, economy: 15 }
            },
            factory: { 
                color: 0xe17055, 
                height: 3, 
                name: "Â∑•Â†¥Âú∞Âå∫",
                effects: { income: 1000, environment: -10 }
            },
            tech_park: { 
                color: 0x00cec9, 
                height: 4, 
                name: "„Éè„Ç§„ÉÜ„ÇØ„Éë„Éº„ÇØ",
                effects: { income: 2000, economy: 20 }
            },
            park: { 
                color: 0x00b894, 
                height: 0.5, 
                name: "‰∏≠Â§ÆÂÖ¨Âúí",
                effects: { environment: 15, happiness: 10 }
            },
            solar_farm: { 
                color: 0xf9ca24, 
                height: 1, 
                name: "Â§™ÈôΩÂÖâÁô∫ÈõªÊâÄ",
                effects: { environment: 25, income: 400 }
            },
            stadium: { 
                color: 0x6c5ce7, 
                height: 3, 
                name: "„Çπ„Çø„Ç∏„Ç¢„É†",
                effects: { happiness: 20, income: 1000 }
            },
            landmark: { 
                color: 0xa29bfe, 
                height: 8, 
                name: "„É©„É≥„Éâ„Éû„Éº„ÇØ„Çø„ÉØ„Éº",
                effects: { cityLevel: 2, income: 2000 }
            }
        };

        function init3D() {
            // „Ç∑„Éº„É≥Ë®≠ÂÆö
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // „Ç´„É°„É©Ë®≠ÂÆö
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(25, 20, 25);
            camera.lookAt(0, 0, 0);
            
            // „É¨„É≥„ÉÄ„É©„ÉºË®≠ÂÆö
            const container = document.getElementById('city3d');
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // „Ç≥„É≥„Éà„É≠„Éº„É´Ë®≠ÂÆö
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // „É©„Ç§„ÉÜ„Ç£„É≥„Ç∞Ë®≠ÂÆö
            setupLighting();
            
            // Âú∞Èù¢‰ΩúÊàê
            createGround();
            
            // ÈÅìË∑Ø‰ΩúÊàê
            createRoads();
            
            // „Ç∞„É™„ÉÉ„ÉâÂàùÊúüÂåñ
            initGrid();
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„É´„Éº„Éó
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            
            // „É™„Çµ„Ç§„Ç∫ÂØæÂøú
            window.addEventListener('resize', onWindowResize);
        }

        function setupLighting() {
            // Áí∞Â¢ÉÂÖâ
            ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            // Â§™ÈôΩÂÖâ
            sunLight = new THREE.DirectionalLight(0xffffff, 1);
            sunLight.position.set(10, 20, 5);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            scene.add(sunLight);
        }

        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x3d9970,
                side: THREE.DoubleSide 
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // „Ç∞„É™„ÉÉ„Éâ„Éò„É´„Éë„Éº
            const gridHelper = new THREE.GridHelper(50, 50, 0x000000, 0x000000);
            scene.add(gridHelper);
        }

        function createRoads() {
            const roadMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            
            // ‰∏ªË¶ÅÈÅìË∑Ø
            for (let i = -20; i <= 20; i += 10) {
                const roadGeometry = new THREE.PlaneGeometry(50, 2);
                const road1 = new THREE.Mesh(roadGeometry, roadMaterial);
                road1.rotation.x = -Math.PI / 2;
                road1.position.set(0, 0.01, i);
                
                const road2 = new THREE.Mesh(roadGeometry, roadMaterial);
                road2.rotation.x = -Math.PI / 2;
                road2.rotation.z = Math.PI / 2;
                road2.position.set(i, 0.01, 0);
                
                scene.add(road1);
                scene.add(road2);
            }
        }

        function initGrid() {
            for (let x = -22; x <= 22; x += 4) {
                for (let z = -22; z <= 22; z += 4) {
                    // ÈÅìË∑Ø„ÅÆ‰ΩçÁΩÆ„ÅØÈô§Â§ñ
                    if (x % 10 === 0 || z % 10 === 0) continue;
                    grid.push({ x, z, occupied: false });
                }
            }
        }

        function buildBuilding(type) {
            const cost = parseInt(document.querySelector(`[onclick="buildBuilding('${type}')"]`).dataset.cost);
            
            if (gameState.money < cost) {
                showNotification('üí∞ Ë≥áÈáë„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ');
                return;
            }
            
            const availableSpots = grid.filter(spot => !spot.occupied);
            if (availableSpots.length === 0) {
                showNotification('üöß Âª∫Ë®≠„Åß„Åç„ÇãÁ©∫Âú∞„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅ');
                return;
            }
            
            const spot = availableSpots[Math.floor(Math.random() * availableSpots.length)];
            spot.occupied = true;
            
            // Âª∫Ë®≠„Ç®„Éï„Çß„ÇØ„Éà
            showConstructionEffect(spot.x, spot.z);
            
            setTimeout(() => {
                create3DBuilding(type, spot.x, spot.z);
                gameState.money -= cost;
                applyBuildingEffects(type);
                checkAchievements();
                updateUI();
                showNotification(`‚úÖ ${buildingConfigs[type].name}„ÇíÂª∫Ë®≠„Åó„Åæ„Åó„ÅüÔºÅ`);
            }, 800);
        }

        function create3DBuilding(type, x, z) {
            const config = buildingConfigs[type];
            
            // „É°„Ç§„É≥„Éì„É´
            const geometry = new THREE.BoxGeometry(3, config.height, 3);
            const material = new THREE.MeshLambertMaterial({ color: config.color });
            const building = new THREE.Mesh(geometry, material);
            building.position.set(x, config.height / 2, z);
            building.castShadow = true;
            building.receiveShadow = true;
            
            // Ë©≥Á¥∞„Å™Ë£ÖÈ£æÔºàÁ™ì„Å™„Å©Ôºâ
            if (config.height > 2) {
                const windowGeometry = new THREE.BoxGeometry(0.1, 0.3, 1.5);
                const windowMaterial = new THREE.MeshLambertMaterial({ color: 0x87CEEB });
                
                for (let i = 1; i < config.height; i += 0.8) {
                    const window1 = new THREE.Mesh(windowGeometry, windowMaterial);
                    window1.position.set(x + 1.6, i, z);
                    
                    const window2 = new THREE.Mesh(windowGeometry, windowMaterial);
                    window2.position.set(x - 1.6, i, z);
                    
                    scene.add(window1);
                    scene.add(window2);
                }
            }
            
            building.userData = { type, x, z };
            scene.add(building);
            buildingMeshes.push(building);
            
            gameState.buildings.push({ type, x, z, level: 1 });
        }

        function applyBuildingEffects(type) {
            const effects = buildingConfigs[type].effects;
            
            Object.keys(effects).forEach(key => {
                if (key === 'cityLevel') {
                    gameState.cityLevel += effects[key];
                } else {
                    gameState[key] += effects[key];
                    // ÂÄ§„ÇíÂà∂Èôê
                    if (key !== 'population' && key !== 'income') {
                        gameState[key] = Math.max(0, Math.min(100, gameState[key]));
                    }
                }
            });
            
            recalculateHappiness();
        }

        function recalculateHappiness() {
            const base = 50;
            const envBonus = (gameState.environment - 50) * 0.4;
            const economyBonus = (gameState.economy - 50) * 0.3;
            const popDensity = Math.max(0, (gameState.population - 10000) / 2000) * -2;
            
            gameState.happiness = Math.max(0, Math.min(100, base + envBonus + economyBonus + popDensity));
        }

        function showConstructionEffect(x, z) {
            const effectsContainer = document.getElementById('constructionEffects');
            const effect = document.createElement('div');
            effect.className = 'construction-effect pulse';
            effect.style.cssText = `
                width: 60px;
                height: 60px;
                background: radial-gradient(circle, #FFD700 20%, transparent 70%);
                border-radius: 50%;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
            `;
            effectsContainer.appendChild(effect);
            
            setTimeout(() => effect.remove(), 1500);
        }

        function nextTurn() {
            gameState.turn++;
            gameState.money += gameState.income;
            gameState.population += Math.floor(gameState.population * 0.03);
            
            // Áí∞Â¢É„ÅÆËá™ÁÑ∂Â§âÂåñ
            if (gameState.economy > 70) {
                gameState.environment = Math.max(0, gameState.environment - 2);
            }
            
            updateUI();
            showNotification(`üìä „Çø„Éº„É≥ ${gameState.turn}:
ÂèéÂÖ•: +${gameState.income.toLocaleString()}ÂÜÜ
‰∫∫Âè£: +${Math.floor(gameState.population * 0.03).toLocaleString()}‰∫∫`);
        }

        function toggleDayNight() {
            gameState.isDay = !gameState.isDay;
            if (gameState.isDay) {
                scene.background = new THREE.Color(0x87CEEB);
                sunLight.intensity = 1;
                ambientLight.intensity = 0.6;
                document.querySelector('.day-night-toggle').textContent = 'üåô Â§ú„É¢„Éº„Éâ';
            } else {
                scene.background = new THREE.Color(0x2c3e50);
                sunLight.intensity = 0.3;
                ambientLight.intensity = 0.3;
                document.querySelector('.day-night-toggle').textContent = '‚òÄÔ∏è Êòº„É¢„Éº„Éâ';
            }
        }

        function showCityReport() {
            const report = `
üèôÔ∏è ÈÉΩÂ∏Ç„É¨„Éù„Éº„Éà - „Çø„Éº„É≥ ${gameState.turn}

üìà Âü∫Êú¨Áµ±Ë®à:
‚Ä¢ Á∑è‰∫∫Âè£: ${gameState.population.toLocaleString()}‰∫∫
‚Ä¢ Áí∞Â¢ÉÊåáÊï∞: ${gameState.environment}%
‚Ä¢ ÁµåÊ∏àÊàêÈï∑: ${gameState.economy}%
‚Ä¢ Â∏ÇÊ∞ëÂπ∏Á¶èÂ∫¶: ${gameState.happiness}%

üí∞ Ë≤°Êîø:
‚Ä¢ Ë≥áÈáë: ${gameState.money.toLocaleString()}ÂÜÜ
‚Ä¢ „Çø„Éº„É≥ÂèéÂÖ•: ${gameState.income.toLocaleString()}ÂÜÜ

üéØ ÁõÆÊ®ô:
‚Ä¢ SDGsÈÅîÊàêÂ∫¶: ${Math.min(100, Math.floor((gameState.environment + gameState.economy + gameState.happiness) / 3))}%
‚Ä¢ ÈÉΩÂ∏Ç„É¨„Éô„É´: ${gameState.cityLevel}
            `;
            
            alert(report);
        }

        function checkAchievements() {
            const newAchievements = [];
            
            if (gameState.buildings.length >= 5 && !gameState.achievements.includes('üèóÔ∏è Âª∫Ë®≠„Éû„Çπ„Çø„Éº')) {
                newAchievements.push('üèóÔ∏è Âª∫Ë®≠„Éû„Çπ„Çø„Éº');
            }
            
            if (gameState.population >= 10000 && !gameState.achievements.includes('üë• Â§ßÈÉΩÂ∏Ç')) {
                newAchievements.push('üë• Â§ßÈÉΩÂ∏Ç');
            }
            
            if (gameState.money >= 5000000 && !gameState.achievements.includes('üí∞ ÂÑÑ‰∏áÈï∑ËÄÖ')) {
                newAchievements.push('üí∞ ÂÑÑ‰∏áÈï∑ËÄÖ');
            }
            
            newAchievements.forEach(achievement => {
                gameState.achievements.push(achievement);
                showAchievementPopup(achievement);
            });
        }

        function showAchievementPopup(achievement) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">üèÜ</div>
                <div style="font-weight: bold; font-size: 18px;">ÂÆüÁ∏æÁç≤ÂæóÔºÅ</div>
                <div>${achievement}</div>
            `;
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 3000);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'floating-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        function updateUI() {
            document.getElementById('money').textContent = gameState.money.toLocaleString();
            document.getElementById('income').textContent = '+' + gameState.income.toLocaleString();
            document.getElementById('population').textContent = gameState.population.toLocaleString();
            document.getElementById('environment').textContent = gameState.environment + '%';
            document.getElementById('economy').textContent = gameState.economy + '%';
            document.getElementById('happiness').textContent = gameState.happiness + '%';
            document.getElementById('turn').textContent = gameState.turn;
            document.getElementById('cityLevel').textContent = gameState.cityLevel;
            
            // SDGsÈÄ≤Êçó
            const sdgsProgress = Math.min(100, Math.floor((gameState.environment + gameState.economy + gameState.happiness) / 3));
            document.getElementById('sdgsProgress').textContent = sdgsProgress + '%';
            document.querySelector('.progress-bar').style.width = sdgsProgress + '%';
            
            // Âª∫Áâ©„Ç´„Éº„Éâ„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.building-card').forEach(card => {
                const cost = parseInt(card.dataset.cost);
                card.className = `building-card ${gameState.money >= cost ? 'available' : 'unavailable'}`;
            });
            
            // ÂÆüÁ∏æË°®Á§∫Êõ¥Êñ∞
            const achievementsContainer = document.getElementById('achievements');
            achievementsContainer.innerHTML = gameState.achievements
                .map(ach => `<div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 5px;">${ach}</div>`)
                .join('');
        }

        function onWindowResize() {
            const container = document.getElementById('city3d');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            init3D();
            updateUI();
        });
    </script>
</body>
</html>
