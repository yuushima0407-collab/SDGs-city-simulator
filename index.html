// ===========================
// SDGséƒ½å¸‚çµŒå–¶ã‚²ãƒ¼ãƒ  main.js æ”¹è‰¯ç‰ˆï¼ˆ15éƒ½å¸‚å¯¾å¿œï¼‰
// ===========================
(function () {
  window.addEventListener("DOMContentLoaded", () => {
    // --- çŠ¶æ…‹ç®¡ç† ---
    let currentQuestionIndex = 0;
    let status = { env: 50, eco: 50, soc: 50 };
    let resources = { energy: 0, food: 0, tech: 0, funds: 50, labor: 0, water: 0, recycled: 0 };
    let cityTypePoints = {
      eco:0, industry:0, social:0, smart:0, science:0,
      culture:0, tourism:0, agriculture:0, industryHeavy:0,
      urban:0, infra:0, housing:0, welfare:0, education:0, transport:0
    };

    // --- DOMå–å¾— ---
    const $ = (id) => document.getElementById(id);
    const startBtn = $("btn-start");
    const questionTitle = $("question-title");
    const questionDesc = $("question-desc");
    const choiceButtons = $("choices");
    const explainBox = $("explainBox");
    const progressText = $("progress");
    const cityBg = $("city-bg");
    const cityInfoName = $("city-info-name");
    const cityInfoLevel = $("city-info-level");
    const cityInfoDesc = $("city-info-desc");
    const cityInfoResources = $("city-info-resources");

    // å³ãƒ‘ãƒãƒ«ãƒªã‚½ãƒ¼ã‚¹è¡¨ç¤º
    const envBar = $("res-env");
    const ecoBar = $("res-eco");
    const socBar = $("res-soc");
    const energyBar = $("res-energy");
    const foodBar = $("res-food");

    const cityTypeUI = {
      eco: $("tp-eco"), industry: $("tp-industry"), social: $("tp-social"), smart: $("tp-smart"),
      science: $("tp-science"), culture: $("tp-culture"), tourism: $("tp-tourism"), agriculture: $("tp-agriculture"),
      industryHeavy: $("tp-industryHeavy"), urban: $("tp-urban"), infra: $("tp-infra"), housing: $("tp-housing"),
      welfare: $("tp-welfare"), education: $("tp-education"), transport: $("tp-transport")
    };

    // --- cities ã¯ data.js ã§å®šç¾©æ¸ˆã¿ ---
    if (typeof cities === "undefined") {
      alert("data.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ ---
    if (startBtn) startBtn.addEventListener("click", startGame);

    function startGame() {
      currentQuestionIndex = 0;
      status = { env: 50, eco: 50, soc: 50 };
      resources = { energy: 0, food: 0, tech: 0, funds: 50, labor: 0, water: 0, recycled: 0 };
      for (const key in cityTypePoints) cityTypePoints[key] = 0;
      explainBox.style.display = "none";
      updateStatusUI();
      updateCityTypePointsUI();
      showQuestion();
    }

    function showQuestion() {
      if (currentQuestionIndex >= cities.length) return showResult();
      const q = cities[currentQuestionIndex];
      questionTitle.textContent = q.title || "ç„¡é¡Œã®è³ªå•";
      questionDesc.textContent = q.description || "";
      choiceButtons.innerHTML = "";

      q.choices.forEach((choice) => {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = choice.text;

        // ãƒªã‚½ãƒ¼ã‚¹æ¡ä»¶åˆ¤å®š
        let canSelect = true;
        if (choice.resources) {
          for (const k in choice.resources) {
            if (choice.resources[k] < 0 && (resources[k] || 0) < Math.abs(choice.resources[k])) {
              canSelect = false;
              btn.title = `${k}ä¸è¶³ã§é¸æŠã§ãã¾ã›ã‚“`;
            }
          }
        }
        if (!canSelect) { btn.disabled = true; btn.style.opacity = 0.5; }

        btn.onclick = () => selectChoice(choice);
        choiceButtons.appendChild(btn);
      });

      progressText.textContent = `å•é¡Œ ${currentQuestionIndex + 1}/${cities.length}`;
    }

    function selectChoice(choice) {
      applyEffects(choice.effects);
      applyTypePoints(choice.typePoints);
      applyResources(choice.resources);
      updateStatusUI();
      updateCityTypePointsUI();
      explainBox.style.display = "block";
      explainBox.textContent = choice.explanation || "é¸æŠçµæœãŒåæ˜ ã•ã‚Œã¾ã—ãŸã€‚";
      currentQuestionIndex++;
      setTimeout(showQuestion, 1200);
    }

    function applyEffects(effects) {
      if (!effects) return;
      status.env = clamp(status.env + (effects.env || 0), 0, 100);
      status.eco = clamp(status.eco + (effects.eco || 0), 0, 100);
      status.soc = clamp(status.soc + (effects.soc || 0), 0, 100);
    }

    function applyTypePoints(points) {
      if (!points) return;
      for (const k in points) cityTypePoints[k.toLowerCase()] = (cityTypePoints[k.toLowerCase()] || 0) + points[k];
    }

    function applyResources(res) {
      if (!res) return;
      for (const k in res) resources[k] = (resources[k] || 0) + res[k];
    }

    function updateStatusUI() {
      envBar.textContent = status.env;
      ecoBar.textContent = status.eco;
      socBar.textContent = status.soc;
      energyBar.textContent = resources.energy;
      foodBar.textContent = resources.food;
    }

    function updateCityTypePointsUI() {
      for (const key in cityTypePoints) {
        if (cityTypeUI[key]) cityTypeUI[key].textContent = `${cityTypePoints[key]}`;
      }
    }

    function showResult() {
      questionTitle.textContent = "ğŸŒ†éƒ½å¸‚ã®æœ€çµ‚çµæœ";
      questionDesc.textContent = "ã‚ãªãŸã®é¸æŠãŒéƒ½å¸‚ã‚’å½¢ä½œã‚Šã¾ã—ãŸã€‚";
      choiceButtons.innerHTML = "";
      explainBox.style.display = "block";
      explainBox.textContent = `
        ğŸŒ¿ç’°å¢ƒ: ${status.env}
        ğŸ’°çµŒæ¸ˆ: ${status.eco}
        ğŸ¤ç¤¾ä¼š: ${status.soc}
        âš¡ã‚¨ãƒãƒ«ã‚®ãƒ¼: ${resources.energy}
        ğŸé£Ÿæ–™: ${resources.food}
        ğŸ§ æŠ€è¡“: ${resources.tech}
      `;
      progressText.textContent = "å…¨å•é¡Œçµ‚äº†";
    }

    function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

  }); // DOMContentLoaded
})();
